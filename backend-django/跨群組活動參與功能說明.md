# 跨群組活動參與功能說明

## 📋 概述

系統現已支持跨群組活動參與功能，活動管理者可以邀請任何系統用戶參與活動，不再限制於活動所屬群組的成員。這個功能大幅提升了活動的靈活性，適用於多群組協作和臨時活動組織。

## 🎯 功能特點

### 1. 靈活的活動創建
- **可選群組綁定**：創建活動時，群組選擇變為可選項
- **純跨群組活動**：支持不綁定任何群組的獨立活動
- **混合參與者**：同一活動可包含多個群組的成員和獨立用戶

### 2. 全系統用戶邀請
- **無群組限制**：可邀請系統中任何註冊用戶
- **實時邀請**：在活動編輯頁面即時邀請新參與者
- **角色顯示**：清楚顯示被邀請用戶的系統角色

### 3. 智能用戶分類
- **群組成員**：優先顯示活動所屬群組的成員
- **其他用戶**：分別列出非群組成員的系統用戶
- **去重顯示**：避免重複顯示已是群組成員的用戶

## 🔧 技術實現

### 後端修改

#### 移除群組成員限制
```python
# apps/events/views.py - invite_participant 方法
# 原本的限制檢查已移除
# if activity.group and not activity.group.members.filter(user=user).exists():
#     return Response({'error': f'{user.name} 不是此群組的成員，無法加入活動'})

# 改為：
# 允許管理員邀請任何用戶，不限制群組成員身份
# 這使得活動可以跨群組邀請參與者
```

### 前端實現

#### ActivityNew.tsx - 活動創建頁面
- 添加 `crossGroupParticipants` 狀態管理跨群組參與者
- 群組選擇變為可選（可創建純跨群組活動）
- 新增「邀請其他用戶」區塊，列出所有非群組成員用戶

#### ActivityEdit.tsx - 活動編輯頁面
- 新增全系統用戶查詢：`useQuery(['users'])`
- 分別顯示群組成員和其他系統用戶
- 添加用戶角色標識，方便識別用戶類型

## 🎨 用戶界面

### 活動創建頁面
```
群組與參與者
├── 選擇主要群組（可選）
├── 選擇參與者（群組成員）
└── 邀請其他用戶
    ├── 系統管理員
    ├── 群組管理員  
    └── 一般用戶
```

### 活動編輯頁面
```
參與者管理
├── 目前參與者列表
├── 邀請群組成員
└── 邀請其他用戶
    └── 按角色分類顯示
```

## 📊 使用場景

### 1. 跨群組協作活動
**場景**：公司部門間的聯合活動
- 主辦群組：行政部
- 參與者：包含各部門代表
- 優勢：統一管理，分攤計算準確

### 2. 臨時活動組織
**場景**：臨時聚餐或出遊
- 不綁定特定群組
- 邀請相關朋友和同事
- 優勢：靈活組織，快速邀請

### 3. 大型活動管理
**場景**：年會或大型聚會
- 主要群組：籌備委員會
- 參與者：全公司員工
- 優勢：統一財務管理，透明分攤

## 🔐 權限控制

### 邀請權限
- **超級管理員**：可邀請任何用戶到任何活動
- **活動管理者**：可邀請任何用戶到自己管理的活動
- **群組管理者**：在活動編輯時可邀請任何用戶

### 參與限制
- **支出創建**：非參與者無法為活動創建支出
- **活動查看**：非參與者無法查看活動詳情
- **分攤計算**：只有活動參與者會被納入分攤計算

## ⚠️ 注意事項

### 1. 數據一致性
- 跨群組參與者仍需遵循相同的分攤規則
- 活動結算時統一處理所有參與者

### 2. 權限管理
- 邀請用戶不會獲得活動管理權限
- 需要額外操作才能將參與者升級為管理者

### 3. 群組關聯
- 即使是跨群組活動，仍建議綁定主要群組以便管理
- 純跨群組活動的群組欄位為 null

## 🔄 業務流程

### 創建跨群組活動
1. 選擇主要群組（可選）
2. 選擇群組內參與者（如果有群組）
3. 選擇系統內其他用戶
4. 創建活動，所有選中用戶自動成為參與者

### 邀請新參與者
1. 進入活動編輯頁面
2. 在「參與者管理」區塊查看當前參與者
3. 從「邀請群組成員」或「邀請其他用戶」中選擇
4. 點擊邀請，用戶立即成為活動參與者

### 管理參與者
1. 查看參與者列表，包含加入時間
2. 識別參與者來源（群組成員 vs 跨群組邀請）
3. 必要時可將參與者升級為活動管理者

## 📈 預期效益

### 1. 提升靈活性
- 不再受限於固定群組結構
- 支持臨時性和跨組織活動
- 適應多樣化的活動組織需求

### 2. 改善用戶體驗
- 簡化邀請流程
- 減少手動添加參與者的步驟
- 提供清晰的參與者管理界面

### 3. 擴大應用場景
- 支持更多類型的財務活動
- 促進跨部門協作
- 增強系統的實用性

## 📝 更新記錄

- 2025-08-07: 初始版本，實現跨群組邀請功能
- 2025-08-07: 更新活動創建和編輯頁面的參與者選擇界面
- 2025-08-07: 移除後端群組成員限制，支持任意用戶邀請