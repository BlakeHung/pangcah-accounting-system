# 新增活動權限修復指南

## 🎯 問題描述

群組管理者無法看到「新增活動」按鈕，點擊後也無法進入 ActivityNew 頁面，導致只有 ADMIN 用戶能創建活動。

## 🔍 根因分析

### 1. 前端權限邏輯錯誤
Activities.tsx 和 ActivityNew.tsx 使用了不存在的 `GROUP_MANAGER` 角色：

```typescript
// 錯誤的權限檢查
if (user.role !== 'ADMIN' && user.role !== 'GROUP_MANAGER') {
  navigate('/activities')
  return
}
```

**問題**：用戶模型中只有 `ADMIN` 和 `USER` 兩種角色，沒有 `GROUP_MANAGER`。

### 2. 後端API缺少群組管理信息
`/api/v1/auth/users/me/` 端點使用 `UserSerializer` 而非 `UserDetailSerializer`，導致返回的用戶資料缺少 `managed_groups` 欄位。

### 3. 前端用戶資料不完整
登入時儲存的用戶資料沒有包含群組管理信息，無法正確判斷權限。

## ✅ 修復方案

### 1. 後端修復：更新 users/me 端點

**文件**：`apps/users/views.py`

```python
@action(detail=False, methods=['get'])
def me(self, request):
    """獲取當前用戶資訊"""
    if request.user.is_authenticated:
        return Response(UserDetailSerializer(request.user).data)  # 改用 UserDetailSerializer
    return Response({'error': '未登入'}, status=status.HTTP_401_UNAUTHORIZED)
```

### 2. 前端修復：更新權限檢查邏輯

#### Activities.tsx
```typescript
interface ManagedGroup {
  id: number
  name: string
  description: string
}

interface User {
  id: number
  username: string
  name: string
  role: string
  managed_groups?: ManagedGroup[]  // 新增群組管理信息
}

const canManageActivities = (): boolean => {
  if (!currentUser) return false
  
  // ADMIN可以新增活動
  if (currentUser.role === 'ADMIN') return true
  
  // 群組管理者可以新增活動 - 檢查是否管理任何群組
  if (currentUser.managed_groups && currentUser.managed_groups.length > 0) return true
  
  return false
}
```

#### ActivityNew.tsx
```typescript
// 檢查是否有權限創建活動
const canCreateActivity = user.role === 'ADMIN' || (user.managed_groups && user.managed_groups.length > 0)
if (!canCreateActivity) {
  navigate('/activities')
  return
}
```

#### LoginPage.tsx
```typescript
// 儲存完整的用戶資訊
const userInfo = {
  id: userResponse.data.id,
  username: userResponse.data.username,
  name: userResponse.data.name || userResponse.data.username,
  email: userResponse.data.email,
  role: userResponse.data.role,
  is_active: userResponse.data.is_active,
  date_joined: userResponse.data.date_joined,
  last_login: userResponse.data.last_login,
  managed_groups: userResponse.data.managed_groups || []  // 新增群組管理信息
}
```

## 🧪 測試驗證

### 測試用戶和期望結果

1. **admin** (ADMIN角色)
   ```json
   {
     "role": "ADMIN",
     "managed_groups": [{"id": 1, "name": "核心家庭"}]
   }
   ```
   ✅ 可以看到「新增活動」按鈕，可以進入ActivityNew頁面

2. **alice** (USER角色，管理2個群組)
   ```json
   {
     "role": "USER", 
     "managed_groups": [
       {"id": 1, "name": "核心家庭"},
       {"id": 2, "name": "大家庭聚會"}
     ]
   }
   ```
   ✅ 可以看到「新增活動」按鈕，可以進入ActivityNew頁面

3. **charlie** (USER角色，不管理任何群組)
   ```json
   {
     "role": "USER",
     "managed_groups": []
   }
   ```
   ❌ 看不到「新增活動」按鈕，無法進入ActivityNew頁面

### API測試命令

```bash
# 1. 登入獲取token
curl -X POST http://localhost:8000/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username": "alice", "password": "password123"}'

# 2. 檢查用戶資料是否包含 managed_groups
curl -H "Authorization: Bearer <token>" \
  http://localhost:8000/api/v1/auth/users/me/ | jq
```

## 🔐 權限邏輯說明

### 創建活動權限判斷
```typescript
const canCreateActivity = user.role === 'ADMIN' || (user.managed_groups && user.managed_groups.length > 0)
```

**解釋**：
- `user.role === 'ADMIN'`：超級管理員永遠可以創建活動
- `user.managed_groups && user.managed_groups.length > 0`：管理任何數量的群組都可以創建活動

**重要**：不需要管理「兩個以上」群組，只要管理至少一個群組就有權限。

### 角色與權限對應

| 用戶狀態 | role | managed_groups | 可創建活動 |
|---------|------|----------------|-----------|
| 超級管理員 | ADMIN | 任意 | ✅ |
| 群組管理者 | USER | length > 0 | ✅ |
| 一般用戶 | USER | length = 0 | ❌ |

## 📋 修復檢查清單

- [x] 後端 `/api/v1/auth/users/me/` 端點返回 `managed_groups`
- [x] Activities.tsx 權限邏輯更新為檢查 `managed_groups.length > 0`
- [x] ActivityNew.tsx 權限邏輯更新為檢查 `managed_groups.length > 0`
- [x] LoginPage.tsx 保存用戶資料時包含 `managed_groups`
- [x] User 介面定義包含 `managed_groups` 欄位
- [x] API 測試驗證三種用戶類型的權限

## 🚨 注意事項

1. **角色混淆**：系統中沒有 `GROUP_MANAGER` 角色，群組管理者通過 `managed_groups` 欄位判斷
2. **權限來源**：創建活動的權限來自於「管理群組」的關係，而非用戶角色
3. **API一致性**：確保所有需要用戶資料的地方都使用包含 `managed_groups` 的完整資料

## 🔧 相關文件

- `apps/users/views.py` - 用戶API視圖
- `apps/users/serializers.py` - 用戶序列化器
- `frontend/src/pages/Activities.tsx` - 活動列表頁面
- `frontend/src/pages/ActivityNew.tsx` - 新增活動頁面
- `frontend/src/pages/LoginPage.tsx` - 登入頁面

修復完成後，群組管理者可以正常看到「新增活動」按鈕並成功進入創建活動頁面。