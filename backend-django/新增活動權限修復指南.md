# æ–°å¢æ´»å‹•æ¬Šé™ä¿®å¾©æŒ‡å—

## ğŸ¯ å•é¡Œæè¿°

ç¾¤çµ„ç®¡ç†è€…ç„¡æ³•çœ‹åˆ°ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•ï¼Œé»æ“Šå¾Œä¹Ÿç„¡æ³•é€²å…¥ ActivityNew é é¢ï¼Œå°è‡´åªæœ‰ ADMIN ç”¨æˆ¶èƒ½å‰µå»ºæ´»å‹•ã€‚

## ğŸ” æ ¹å› åˆ†æ

### 1. å‰ç«¯æ¬Šé™é‚è¼¯éŒ¯èª¤
Activities.tsx å’Œ ActivityNew.tsx ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ `GROUP_MANAGER` è§’è‰²ï¼š

```typescript
// éŒ¯èª¤çš„æ¬Šé™æª¢æŸ¥
if (user.role !== 'ADMIN' && user.role !== 'GROUP_MANAGER') {
  navigate('/activities')
  return
}
```

**å•é¡Œ**ï¼šç”¨æˆ¶æ¨¡å‹ä¸­åªæœ‰ `ADMIN` å’Œ `USER` å…©ç¨®è§’è‰²ï¼Œæ²’æœ‰ `GROUP_MANAGER`ã€‚

### 2. å¾Œç«¯APIç¼ºå°‘ç¾¤çµ„ç®¡ç†ä¿¡æ¯
`/api/v1/auth/users/me/` ç«¯é»ä½¿ç”¨ `UserSerializer` è€Œé `UserDetailSerializer`ï¼Œå°è‡´è¿”å›çš„ç”¨æˆ¶è³‡æ–™ç¼ºå°‘ `managed_groups` æ¬„ä½ã€‚

### 3. å‰ç«¯ç”¨æˆ¶è³‡æ–™ä¸å®Œæ•´
ç™»å…¥æ™‚å„²å­˜çš„ç”¨æˆ¶è³‡æ–™æ²’æœ‰åŒ…å«ç¾¤çµ„ç®¡ç†ä¿¡æ¯ï¼Œç„¡æ³•æ­£ç¢ºåˆ¤æ–·æ¬Šé™ã€‚

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. å¾Œç«¯ä¿®å¾©ï¼šæ›´æ–° users/me ç«¯é»

**æ–‡ä»¶**ï¼š`apps/users/views.py`

```python
@action(detail=False, methods=['get'])
def me(self, request):
    """ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š"""
    if request.user.is_authenticated:
        return Response(UserDetailSerializer(request.user).data)  # æ”¹ç”¨ UserDetailSerializer
    return Response({'error': 'æœªç™»å…¥'}, status=status.HTTP_401_UNAUTHORIZED)
```

### 2. å‰ç«¯ä¿®å¾©ï¼šæ›´æ–°æ¬Šé™æª¢æŸ¥é‚è¼¯

#### Activities.tsx
```typescript
interface ManagedGroup {
  id: number
  name: string
  description: string
}

interface User {
  id: number
  username: string
  name: string
  role: string
  managed_groups?: ManagedGroup[]  // æ–°å¢ç¾¤çµ„ç®¡ç†ä¿¡æ¯
}

const canManageActivities = (): boolean => {
  if (!currentUser) return false
  
  // ADMINå¯ä»¥æ–°å¢æ´»å‹•
  if (currentUser.role === 'ADMIN') return true
  
  // ç¾¤çµ„ç®¡ç†è€…å¯ä»¥æ–°å¢æ´»å‹• - æª¢æŸ¥æ˜¯å¦ç®¡ç†ä»»ä½•ç¾¤çµ„
  if (currentUser.managed_groups && currentUser.managed_groups.length > 0) return true
  
  return false
}
```

#### ActivityNew.tsx
```typescript
// æª¢æŸ¥æ˜¯å¦æœ‰æ¬Šé™å‰µå»ºæ´»å‹•
const canCreateActivity = user.role === 'ADMIN' || (user.managed_groups && user.managed_groups.length > 0)
if (!canCreateActivity) {
  navigate('/activities')
  return
}
```

#### LoginPage.tsx
```typescript
// å„²å­˜å®Œæ•´çš„ç”¨æˆ¶è³‡è¨Š
const userInfo = {
  id: userResponse.data.id,
  username: userResponse.data.username,
  name: userResponse.data.name || userResponse.data.username,
  email: userResponse.data.email,
  role: userResponse.data.role,
  is_active: userResponse.data.is_active,
  date_joined: userResponse.data.date_joined,
  last_login: userResponse.data.last_login,
  managed_groups: userResponse.data.managed_groups || []  // æ–°å¢ç¾¤çµ„ç®¡ç†ä¿¡æ¯
}
```

## ğŸ§ª æ¸¬è©¦é©—è­‰

### æ¸¬è©¦ç”¨æˆ¶å’ŒæœŸæœ›çµæœ

1. **admin** (ADMINè§’è‰²)
   ```json
   {
     "role": "ADMIN",
     "managed_groups": [{"id": 1, "name": "æ ¸å¿ƒå®¶åº­"}]
   }
   ```
   âœ… å¯ä»¥çœ‹åˆ°ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•ï¼Œå¯ä»¥é€²å…¥ActivityNewé é¢

2. **alice** (USERè§’è‰²ï¼Œç®¡ç†2å€‹ç¾¤çµ„)
   ```json
   {
     "role": "USER", 
     "managed_groups": [
       {"id": 1, "name": "æ ¸å¿ƒå®¶åº­"},
       {"id": 2, "name": "å¤§å®¶åº­èšæœƒ"}
     ]
   }
   ```
   âœ… å¯ä»¥çœ‹åˆ°ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•ï¼Œå¯ä»¥é€²å…¥ActivityNewé é¢

3. **charlie** (USERè§’è‰²ï¼Œä¸ç®¡ç†ä»»ä½•ç¾¤çµ„)
   ```json
   {
     "role": "USER",
     "managed_groups": []
   }
   ```
   âŒ çœ‹ä¸åˆ°ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•ï¼Œç„¡æ³•é€²å…¥ActivityNewé é¢

### APIæ¸¬è©¦å‘½ä»¤

```bash
# 1. ç™»å…¥ç²å–token
curl -X POST http://localhost:8000/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username": "alice", "password": "password123"}'

# 2. æª¢æŸ¥ç”¨æˆ¶è³‡æ–™æ˜¯å¦åŒ…å« managed_groups
curl -H "Authorization: Bearer <token>" \
  http://localhost:8000/api/v1/auth/users/me/ | jq
```

## ğŸ” æ¬Šé™é‚è¼¯èªªæ˜

### å‰µå»ºæ´»å‹•æ¬Šé™åˆ¤æ–·
```typescript
const canCreateActivity = user.role === 'ADMIN' || (user.managed_groups && user.managed_groups.length > 0)
```

**è§£é‡‹**ï¼š
- `user.role === 'ADMIN'`ï¼šè¶…ç´šç®¡ç†å“¡æ°¸é å¯ä»¥å‰µå»ºæ´»å‹•
- `user.managed_groups && user.managed_groups.length > 0`ï¼šç®¡ç†ä»»ä½•æ•¸é‡çš„ç¾¤çµ„éƒ½å¯ä»¥å‰µå»ºæ´»å‹•

**é‡è¦**ï¼šä¸éœ€è¦ç®¡ç†ã€Œå…©å€‹ä»¥ä¸Šã€ç¾¤çµ„ï¼Œåªè¦ç®¡ç†è‡³å°‘ä¸€å€‹ç¾¤çµ„å°±æœ‰æ¬Šé™ã€‚

### è§’è‰²èˆ‡æ¬Šé™å°æ‡‰

| ç”¨æˆ¶ç‹€æ…‹ | role | managed_groups | å¯å‰µå»ºæ´»å‹• |
|---------|------|----------------|-----------|
| è¶…ç´šç®¡ç†å“¡ | ADMIN | ä»»æ„ | âœ… |
| ç¾¤çµ„ç®¡ç†è€… | USER | length > 0 | âœ… |
| ä¸€èˆ¬ç”¨æˆ¶ | USER | length = 0 | âŒ |

## ğŸ“‹ ä¿®å¾©æª¢æŸ¥æ¸…å–®

- [x] å¾Œç«¯ `/api/v1/auth/users/me/` ç«¯é»è¿”å› `managed_groups`
- [x] Activities.tsx æ¬Šé™é‚è¼¯æ›´æ–°ç‚ºæª¢æŸ¥ `managed_groups.length > 0`
- [x] ActivityNew.tsx æ¬Šé™é‚è¼¯æ›´æ–°ç‚ºæª¢æŸ¥ `managed_groups.length > 0`
- [x] LoginPage.tsx ä¿å­˜ç”¨æˆ¶è³‡æ–™æ™‚åŒ…å« `managed_groups`
- [x] User ä»‹é¢å®šç¾©åŒ…å« `managed_groups` æ¬„ä½
- [x] API æ¸¬è©¦é©—è­‰ä¸‰ç¨®ç”¨æˆ¶é¡å‹çš„æ¬Šé™

## ğŸš¨ æ³¨æ„äº‹é …

1. **è§’è‰²æ··æ·†**ï¼šç³»çµ±ä¸­æ²’æœ‰ `GROUP_MANAGER` è§’è‰²ï¼Œç¾¤çµ„ç®¡ç†è€…é€šé `managed_groups` æ¬„ä½åˆ¤æ–·
2. **æ¬Šé™ä¾†æº**ï¼šå‰µå»ºæ´»å‹•çš„æ¬Šé™ä¾†è‡ªæ–¼ã€Œç®¡ç†ç¾¤çµ„ã€çš„é—œä¿‚ï¼Œè€Œéç”¨æˆ¶è§’è‰²
3. **APIä¸€è‡´æ€§**ï¼šç¢ºä¿æ‰€æœ‰éœ€è¦ç”¨æˆ¶è³‡æ–™çš„åœ°æ–¹éƒ½ä½¿ç”¨åŒ…å« `managed_groups` çš„å®Œæ•´è³‡æ–™

## ğŸ”§ ç›¸é—œæ–‡ä»¶

- `apps/users/views.py` - ç”¨æˆ¶APIè¦–åœ–
- `apps/users/serializers.py` - ç”¨æˆ¶åºåˆ—åŒ–å™¨
- `frontend/src/pages/Activities.tsx` - æ´»å‹•åˆ—è¡¨é é¢
- `frontend/src/pages/ActivityNew.tsx` - æ–°å¢æ´»å‹•é é¢
- `frontend/src/pages/LoginPage.tsx` - ç™»å…¥é é¢

ä¿®å¾©å®Œæˆå¾Œï¼Œç¾¤çµ„ç®¡ç†è€…å¯ä»¥æ­£å¸¸çœ‹åˆ°ã€Œæ–°å¢æ´»å‹•ã€æŒ‰éˆ•ä¸¦æˆåŠŸé€²å…¥å‰µå»ºæ´»å‹•é é¢ã€‚