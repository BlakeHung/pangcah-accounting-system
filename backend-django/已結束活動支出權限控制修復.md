# 已結束活動支出權限控制修復

## 🎯 需求說明

已結束的活動（狀態為 `COMPLETED` 或 `CANCELLED`）不能隨意新增支出，只有以下角色可以在已結束活動中新增支出：
1. **活動管理者**：該活動的指定管理者
2. **超級管理者**：系統 ADMIN 角色用戶

## 🔧 修復內容

### 1. 後端權限邏輯（已存在）

在 `apps/expenses/views.py` 的 `perform_create` 方法中，已經實現了正確的權限檢查：

```python
def perform_create(self, serializer):
    """創建支出時設置用戶並創建分攤記錄"""
    event = serializer.validated_data.get('event')
    if event:
        # 如果活動已完成或取消，只有活動管理者可以新增
        if event.status in ['COMPLETED', 'CANCELLED']:
            if not event.can_user_manage(self.request.user):
                raise PermissionDenied('只有活動管理者可以在已結束的活動中新增支出')
        else:
            # 活動進行中時的其他檢查...
```

### 2. 前端權限檢查增強

#### TransactionNew.tsx 修復

**A. 表單提交時的權限驗證**

```typescript
// 檢查已結束活動的權限
if (formData.event) {
  const selectedEvent = events.find(e => e.id.toString() === formData.event.toString())
  if (selectedEvent && selectedEvent.status !== 'ACTIVE') {
    // 只有活動管理者和超級管理者可以在已結束的活動中新增支出
    if (!selectedEvent.is_user_manager && currentUser.role !== 'ADMIN') {
      alert('活動已結束，只有活動管理者和超級管理者可以新增支出')
      return
    }
  }
}
```

**B. 活動選項的視覺改進**

```typescript
{events.map(event => {
  const canCreateExpense = event.status === 'ACTIVE' || 
    event.is_user_manager || 
    currentUser?.role === 'ADMIN'
  
  return (
    <option 
      key={event.id} 
      value={event.id}
      disabled={!canCreateExpense}  // 禁用無權限的選項
    >
      {event.name}
      {currentUser?.role === 'ADMIN' ? ' 👑' : ''}
      {event.is_user_manager ? ' 🔧' : ''}
      {event.allow_split ? ' 🔄' : ''}
      {event.status === 'COMPLETED' ? ' (已完成)' : ''}
      {event.status === 'CANCELLED' ? ' (已取消)' : ''}
      {!event.enabled ? ' (已停用)' : ''}
      {!canCreateExpense ? ' 🚫' : ''}
    </option>
  )
})}
```

**C. 添加幫助提示**

```html
<small className="form-hint">
  📌 只有進行中的活動、或您管理的活動可以新增支出
  {currentUser?.role === 'ADMIN' && ' (系統管理員可新增支出到任何活動)'}
</small>
```

#### ActivityManager.tsx 修復

修復活動管理頁面中"新增支出"按鈕的顯示邏輯：

```typescript
// 原邏輯（有問題）
{activity.is_user_participant && !activity.is_locked && (

// 新邏輯（修復後）
{((activity.status === 'ACTIVE' && activity.is_user_participant) || 
  activity.is_user_manager || 
  user?.role === 'ADMIN') && 
  !activity.is_locked && (
```

## 🎨 用戶界面改進

### 圖標說明

- 👑 **超級管理者**：系統 ADMIN 用戶的標識
- 🔧 **活動管理者**：該活動管理者的標識
- 🔄 **可分帳**：活動允許分帳功能
- 🚫 **無權限**：用戶無法在該活動中新增支出
- (已完成) / (已取消)：活動狀態標識

### 權限矩陣

| 用戶角色 | 進行中活動 | 已結束活動 | 已鎖定活動 | 停用活動 |
|---------|-----------|-----------|-----------|----------|
| ADMIN | ✅ | ✅ | ✅ | ✅ |
| 活動管理者 | ✅ | ✅ | ✅ | ✅ |
| 活動參與者 | ✅ | ❌ | ❌ | ❌ |
| 一般用戶 | ❌ | ❌ | ❌ | ❌ |

## 🧪 測試場景

### 場景 1：一般用戶嘗試在已結束活動中新增支出
1. 使用一般用戶登入（非 ADMIN，非活動管理者）
2. 進入 TransactionNew 頁面
3. 選擇已結束的活動 → 選項應該被禁用（🚫 標識）
4. 如果強制選擇並提交 → 應該顯示錯誤信息

### 場景 2：活動管理者在已結束活動中新增支出
1. 使用活動管理者帳號登入
2. 進入 TransactionNew 頁面  
3. 選擇自己管理的已結束活動 → 應該可以選擇（🔧 標識）
4. 填寫並提交 → 應該成功創建支出

### 場景 3：ADMIN 在任何活動中新增支出
1. 使用 ADMIN 帳號登入
2. 進入 TransactionNew 頁面
3. 所有活動都應該可以選擇（👑 標識）
4. 填寫並提交 → 應該成功創建支出

### 場景 4：ActivityManager 頁面按鈕顯示
1. 進入各種狀態的活動管理頁面
2. 檢查"新增支出"按鈕是否根據權限正確顯示/隱藏

## 🔒 安全考量

1. **後端權限為主**：前端的檢查主要是為了用戶體驗，真正的權限控制在後端
2. **錯誤信息明確**：清楚告知用戶為什麼無法執行操作
3. **視覺提示清晰**：使用圖標和文字清楚標識各種狀態和權限

## 📝 相關文件

- 後端權限檢查：`apps/expenses/views.py:perform_create`
- 活動權限模型：`apps/events/models.py:can_user_manage`
- 前端新增支出：`frontend/src/pages/TransactionNew.tsx`
- 活動管理頁面：`frontend/src/pages/ActivityManager.tsx`

這些修復確保了只有有權限的用戶才能在已結束的活動中新增支出，提供了更好的業務邏輯控制和用戶體驗。