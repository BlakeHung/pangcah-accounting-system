# 群組權限管理說明

## 🔐 新增群組（Group）權限

### 當前權限設定

**誰可以新增群組？**
- ✅ **ADMIN（超級管理員）**：可以創建群組
- ❌ **USER（一般用戶）**：無法創建群組
- ❌ **群組管理者**：無法創建群組（只能管理既有群組）

### 權限檢查邏輯

#### 後端權限
```python
# apps/groups/views.py
class GroupViewSet(viewsets.ModelViewSet):
    permission_classes = [permissions.IsAuthenticated]
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)
```

**說明**：後端只檢查用戶是否已登入（`IsAuthenticated`），沒有角色限制。

#### 前端權限
```typescript
// frontend/src/pages/Groups.tsx
const canCreateGroups = (): boolean => {
  return currentUser?.role === 'ADMIN'
}
```

**說明**：前端限制只有 ADMIN 角色可以看到「創建群組」按鈕和表單。

## 📊 群組相關權限矩陣

| 角色類型 | 創建群組 | 編輯群組 | 刪除群組 | 管理成員 | 查看群組 |
|---------|---------|---------|---------|---------|---------|
| ADMIN | ✅ | ✅ | ✅ | ✅ | ✅ |
| 群組管理者 | ❌ | ✅* | ❌ | ✅* | ✅* |
| 群組成員 | ❌ | ❌ | ❌ | ❌ | ✅* |
| 一般用戶 | ❌ | ❌ | ❌ | ❌ | ❌ |

*僅限自己管理/參與的群組

## 🔧 群組管理者的權限

### 如何成為群組管理者？
1. **創建群組時指定**：ADMIN 創建群組時可以指定管理者
2. **後續新增**：由 ADMIN 或現有群組管理者新增

### 群組管理者可以做什麼？
```python
# apps/groups/models.py
def is_manager(self, user) -> bool:
    """檢查指定用戶是否為此群組的管理者"""
    if user.role == 'ADMIN':  # 系統管理員預設為所有群組的管理者
        return True
    return self.managers.filter(id=user.id).exists()
```

**群組管理者權限**：
- ✅ 編輯群組資訊（名稱、描述）
- ✅ 新增/移除群組成員
- ✅ 指定其他群組管理者
- ✅ 創建活動（透過 `managed_groups` 獲得權限）
- ❌ 刪除群組
- ❌ 創建新群組

## 🚀 權限提升建議

### 當前限制
目前只有 ADMIN 可以創建群組，這在大型家族中可能過於限制。

### 建議的權限擴展

#### 選項 1：允許群組管理者創建群組
```typescript
// 前端修改建議
const canCreateGroups = (): boolean => {
  if (!currentUser) return false
  
  // ADMIN 可以創建群組
  if (currentUser.role === 'ADMIN') return true
  
  // 群組管理者也可以創建群組
  if (currentUser.managed_groups && currentUser.managed_groups.length > 0) return true
  
  return false
}
```

#### 選項 2：允許所有用戶創建群組
```typescript
// 完全開放版本
const canCreateGroups = (): boolean => {
  return !!currentUser  // 任何登入用戶都可以創建群組
}
```

## 📋 群組創建流程

### 當前流程（ADMIN only）
1. ADMIN 登入系統
2. 進入群組管理頁面
3. 點擊「創建群組」
4. 填寫群組資訊：
   - 群組名稱（必填）
   - 群組描述（選填）
   - 指定管理者（選填，可多選）
5. 提交創建

### 創建後的自動設定
```python
# apps/groups/views.py
def perform_create(self, serializer):
    serializer.save(created_by=self.request.user)
```

**創建者權限**：
- 創建者自動成為該群組的管理者
- 可以後續編輯群組和管理成員

## 🔍 群組成員管理

### 成員類型
```python
# apps/groups/models.py
class GroupMember(models.Model):
    group = models.ForeignKey(Group)
    name = models.CharField(max_length=100)  # 成員姓名
    user = models.ForeignKey(User, null=True, blank=True)  # 可選的系統用戶關聯
    
    @property
    def is_system_user(self) -> bool:
        return self.user is not None
```

**支援兩種成員**：
1. **系統用戶**：有帳號可登入的用戶
2. **非系統用戶**：只有姓名記錄的家族成員

### 成員管理權限
- **ADMIN**：可管理所有群組的所有成員
- **群組管理者**：可管理自己管理的群組成員
- **其他用戶**：無法管理成員

## 🛡️ 安全考量

### 權限檢查層級
1. **前端檢查**：UI 層面限制，防止誤操作
2. **後端檢查**：API 層面驗證，真正的安全防護
3. **資料庫約束**：模型層面的完整性保護

### 建議加強後端權限
```python
# 建議的後端權限檢查
class GroupViewSet(viewsets.ModelViewSet):
    def get_permissions(self):
        if self.action == 'create':
            # 可以根據需求調整創建權限
            return [permissions.IsAuthenticated()]
        elif self.action in ['update', 'partial_update', 'destroy']:
            return [permissions.IsAuthenticated()]
        return [permissions.IsAuthenticated()]
    
    def check_group_permissions(self, request, group=None):
        """檢查群組操作權限"""
        if request.user.role == 'ADMIN':
            return True
        if group and group.is_manager(request.user):
            return True
        return False
```

## 📝 總結

**當前群組權限特點**：
- ✅ 簡單清晰：只有 ADMIN 能創建群組
- ✅ 安全穩定：避免群組氾濫
- ❌ 可能過於限制：大家族中可能需要更靈活的權限

**建議根據實際使用情況**：
- 小家族：保持現狀（ADMIN only）
- 大家族：考慮允許群組管理者創建群組
- 開放環境：允許所有用戶創建群組

選擇權限策略時需要平衡**便利性**和**管理複雜度**。