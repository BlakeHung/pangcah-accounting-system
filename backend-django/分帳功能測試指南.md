# 分帳功能測試指南

## 🎯 測試目標
測試新增支出時的分帳功能是否根據活動權限正確顯示和運作

## 👥 測試帳號
- **admin** / 密碼: `admin` (系統管理員)
- **alice** / 密碼: `password123` (一般用戶，愛麗絲，核心家庭群組管理者)

## 📋 測試環境設置

### 可用群組
1. **核心家庭** - 包含 admin 和 alice
2. **大家庭聚會** - 其他群組
3. **年輕人小組** - 其他群組

### 測試活動

#### ✅ 允許分帳的活動
1. **週末聚餐 - 測試分帳** (推薦測試)
   - 群組: 核心家庭
   - 狀態: ACTIVE
   - 啟用: True
   - 允許分帳: True
   - 管理者: admin
   - 成員: admin, alice

2. **中秋節烤肉**
   - 群組: 大家庭聚會
   - 允許分帳: True

3. **年輕人聚會**
   - 群組: 年輕人小組
   - 允許分帳: True

#### ⚠️ 不允許分帳的活動
1. **個人記帳 - 不可分帳**
   - 群組: 核心家庭
   - 允許分帳: False

## 🧪 測試步驟

### 第一階段：功能顯示測試

#### 測試1: 分帳選項正確顯示
1. 登入 **admin** 或 **alice**
2. 進入「新增支出」頁面
3. 填寫基本資訊：
   - 類型: 支出 💸
   - 金額: 1000
   - 分類: 選擇任一分類
4. 選擇群組: **核心家庭**
5. 選擇活動: **週末聚餐 - 測試分帳** (應顯示 🔄 標示)
6. **預期結果**: 應該出現「💰 分帳設定」區塊

#### 測試2: 不可分帳活動驗證
1. 同樣填寫基本資訊
2. 選擇群組: **核心家庭**
3. 選擇活動: **個人記帳 - 不可分帳**
4. **預期結果**: 不應該出現「💰 分帳設定」區塊

### 第二階段：分帳功能測試

#### 測試3: 分帳類型選擇
1. 選擇可分帳活動後
2. 在分帳類型中嘗試：
   - 不分帳
   - 平均分攤
   - 比例分攤  
   - 固定金額
3. **預期結果**: 選項切換正常，不同類型顯示不同的輸入界面

#### 測試4: 參與者選擇和分攤設定
1. 選擇「平均分攤」
2. 在參與者選擇中勾選 admin 和 alice
3. **預期結果**: 
   - 出現「分攤詳情設定」區塊
   - 顯示表格形式的分攤界面
   - 平均分攤顯示 "1/2" 比例，無法編輯
   - 即時計算每人應付金額

#### 測試4b: 比例分攤測試
1. 選擇「比例分攤」
2. 勾選兩個參與者
3. 設定比例（如：admin = 2, alice = 1）
4. **預期結果**:
   - 可以輸入小數比例
   - 即時計算金額（1000 的情況下：admin = 666.67, alice = 333.33）
   - 顯示總比例

#### 測試4c: 固定金額測試
1. 選擇「固定金額」
2. 勾選兩個參與者
3. 設定固定金額（如：admin = 600, alice = 400）
4. **預期結果**:
   - 可以輸入具體金額
   - 顯示差額警告（如果總分攤≠總支出）

#### 測試5: 提交測試
1. 完成所有設定後點擊「創建記錄」
2. **預期結果**: 成功創建支出並跳轉到詳情頁

### 第三階段：邊界情況測試

#### 測試6: 無群組情況
1. 不選擇群組，直接選擇活動
2. **預期結果**: 分帳選項不應出現

#### 測試7: 群組切換
1. 先選擇可分帳的活動
2. 然後切換到不同群組
3. **預期結果**: 分帳設定應重置

### 第四階段：ADMIN 權限測試

#### 測試8: ADMIN 超級權限 🔥
1. 使用 **admin** 帳號登入
2. 進入新增支出頁面
3. 選擇群組: **核心家庭**
4. 選擇活動: **個人記帳 - 不可分帳** (注意這個活動不允許分帳)
5. **預期結果**: 
   - 活動選項顯示 👑 標示
   - 仍然出現「💰 分帳設定 👑 管理員權限」區塊
   - ADMIN 可以無視活動權限使用分帳功能

#### 測試9: 一般用戶對照
1. 使用 **alice** 帳號登入
2. 同樣選擇 **個人記帳 - 不可分帳** 活動
3. **預期結果**: 不應出現分帳設定區塊

## 🔍 預期行為總結

### 分帳選項顯示條件

#### 👑 ADMIN 超級管理員
ADMIN 用戶擁有**無限權限**，分帳設定在以下條件滿足時顯示：
- ✅ 支出類型 (不是收入)
- ✅ 已選擇群組
- ✅ 已選擇活動
- ⚡ **無需檢查活動的分帳權限、狀態或啟用狀態**

#### 👤 一般用戶
一般用戶的分帳設定只會在以下條件**全部**滿足時顯示：
- ✅ 支出類型 (不是收入)
- ✅ 已選擇群組
- ✅ 已選擇活動
- ✅ 活動的 allow_split = True
- ✅ 活動的 status = 'ACTIVE'
- ✅ 活動的 enabled = True

### UI 提示
- 👑 ADMIN 用戶在活動選項中會看到王冠標示
- 🔄 允許分帳的活動會顯示分帳標示
- (已結束) 非活動狀態的活動會顯示狀態標示
- (已停用) 被停用的活動會顯示標示
- 👑 管理員權限 在分帳設定標題會顯示ADMIN專用標示
- 選擇參與者時會顯示即時預覽

## 🐛 常見問題排除

1. **分帳選項不顯示**
   - 檢查活動是否允許分帳
   - 確認群組和活動都已選擇
   - 確認是支出而非收入

2. **沒有參與者可選**
   - 檢查群組是否有成員
   - 確認成員是否為系統用戶

3. **提交失敗**
   - 檢查必填欄位是否完整
   - 確認後端API是否正常運行

## 🔐 權限相關測試

### 活動編輯權限測試
1. **Alice 作為群組管理者**
   - 可以查看「核心家庭」群組內所有活動的財務狀況
   - **無法**編輯活動（包括「週末聚餐 - 測試分帳」）
   - 嘗試進入活動編輯頁面會被重導向

2. **Admin 作為系統管理員**
   - 可以編輯所有活動
   - 可以查看所有活動的財務狀況
   - 可以管理活動管理者

### 測試步驟
1. 使用 **alice** 登入
2. 進入活動列表，點擊「週末聚餐 - 測試分帳」
3. 確認可以看到活動的財務資訊
4. 確認**沒有**「編輯」按鈕（或按鈕被禁用）
5. 直接訪問編輯URL會被重導向到活動列表

## 🎉 測試完成標準
- [ ] 分帳選項根據活動權限正確顯示/隱藏
- [ ] 參與者選擇功能正常
- [ ] 即時預覽計算正確
- [ ] 能成功提交分帳支出
- [ ] 邊界情況處理正確
- [ ] 活動編輯權限控制正確
- [ ] 群組管理者只能查看不能編輯