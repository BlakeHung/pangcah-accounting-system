# 活動管理者與參與者關係修復

## 🐛 問題描述

之前的系統設計中，活動管理者和參與者之間有不合理的依賴關係：

1. **管理者必須先是參與者**：`add_manager` 方法要求用戶必須先成為活動參與者才能成為管理者
2. **ADMIN 離開活動後無法重新加入**：ADMIN 離開活動時只是將參與者狀態設為 `is_active=false`，但保留管理者權限，導致再次加入時出現衝突
3. **按鈕顯示邏輯不清楚**：前端按鈕沒有正確反映管理者和參與者的不同狀態

## ✅ 修復內容

### 1. 後端 API 修復

#### `add_manager` 方法修復
```python
# 檢查用戶是否是活動參與者（系統管理員例外）
if user.role != 'ADMIN' and not activity.participants.filter(user_id=user_id, is_active=True).exists():
    return Response(
        {'error': f'{user.name} 必須先是活動參與者才能成為管理者'},
        status=status.HTTP_400_BAD_REQUEST
    )
```

**變更說明**：
- ADMIN 用戶不再需要先成為參與者就可以直接成為活動管理者
- 一般用戶仍需先成為參與者

#### `leave` 方法重構
```python
# 檢查是否是活動管理者
is_manager = activity.managers.filter(id=user.id).exists()

try:
    participant = activity.participants.get(user=user, is_active=True)
except ActivityParticipant.DoesNotExist:
    # 如果用戶不是參與者但是管理者，允許他們"離開"（移除管理者權限）
    if is_manager:
        # 移除管理者權限的邏輯
        activity.managers.remove(user)
        return Response({'message': '已移除管理者權限並離開活動'})
```

**變更說明**：
- 支持純管理者（非參與者）離開活動
- 管理者離開時會同時移除管理權限和參與者狀態
- 確保至少保留一位活動管理者

#### `join` 方法增強
```python
# 如果用戶是 ADMIN 且不是管理者，自動設為管理者
if user.role == 'ADMIN' and not is_manager:
    activity.managers.add(user)
    log_description = f"系統管理員「{user.username}」加入活動並自動成為管理者"
```

**變更說明**：
- ADMIN 用戶加入活動時自動成為管理者
- 記錄詳細的操作日誌

### 2. 前端界面修復

#### 按鈕邏輯改進
```typescript
const canLeave = activity.is_user_participant || activity.is_user_manager

{canLeave && !activity.is_locked && (
  <button 
    className="btn-outline"
    onClick={() => leaveActivityMutation.mutate()}
    disabled={leaveActivityMutation.isPending}
  >
    {activity.is_user_manager && !activity.is_user_participant ? '移除管理權限' : '離開活動'}
  </button>
)}
```

**變更說明**：
- 管理者和參與者都可以看到離開按鈕
- 純管理者看到"移除管理權限"
- 參與者（包括也是管理者的）看到"離開活動"

## 🔄 新的業務邏輯

### 用戶狀態組合

1. **純參與者**：
   - 是活動參與者 (`is_user_participant=true`)
   - 不是管理者 (`is_user_manager=false`)
   - 可以離開活動

2. **純管理者**：
   - 不是參與者 (`is_user_participant=false`)
   - 是管理者 (`is_user_manager=true`)
   - 可以移除管理權限
   - 可以加入成為參與者

3. **管理者+參與者**：
   - 既是參與者又是管理者
   - 離開時會同時失去兩種身份
   - 需要確保不是最後一位管理者

4. **非相關用戶**：
   - 既不是參與者也不是管理者
   - 可以申請加入活動

### 權限矩陣

| 用戶類型 | 加入活動 | 離開活動 | 新增支出 | 管理活動 | 查看財務 |
|---------|---------|---------|---------|---------|---------|
| ADMIN (純管理者) | ✅ 自動成為管理者 | ✅ 移除管理權限 | ❌ 需先成為參與者 | ✅ | ✅ |
| ADMIN (管理者+參與者) | ❌ 已是參與者 | ✅ 離開並移除權限 | ✅ | ✅ | ✅ |
| 活動管理者 (純管理者) | ✅ 成為參與者 | ✅ 移除管理權限 | ❌ 需先成為參與者 | ✅ | ✅ |
| 活動管理者 (管理者+參與者) | ❌ 已是參與者 | ✅ 離開並移除權限 | ✅ | ✅ | ✅ |
| 一般參與者 | ❌ 已是參與者 | ✅ 離開活動 | ✅ | ❌ | ❌ |
| 非相關用戶 | ✅ 成為參與者 | ❌ 不是參與者 | ❌ | ❌ | ❌ |

## 🧪 測試指南

### 測試場景 1：ADMIN 管理活動
1. ADMIN 用戶進入活動管理頁面
2. 點擊"加入活動" → 應該同時成為參與者和管理者
3. 點擊"離開活動" → 應該離開並移除管理權限（如果不是最後一位管理者）
4. 再次點擊"加入活動" → 應該重新成為參與者和管理者

### 測試場景 2：活動管理者管理權限
1. 活動管理者如果不是參與者，顯示"移除管理權限"按鈕
2. 點擊後應該移除管理權限但保持參與者身份（如果有的話）
3. 其他參與者可以被提升為管理者

### 測試場景 3：最後一位管理者保護
1. 確保活動至少有一位管理者
2. 最後一位管理者嘗試離開時應該被阻止
3. 需要先添加其他管理者才能離開

## 📝 API 變更總結

### 新增/修改的端點行為

- `POST /api/v1/events/{id}/join/`
  - ADMIN 用戶自動成為管理者
  - 記錄更詳細的操作日誌

- `POST /api/v1/events/{id}/leave/`
  - 支持純管理者移除管理權限
  - 管理者離開時會同時移除參與者和管理者身份
  - 保護最後一位管理者

- `POST /api/v1/events/{id}/add_manager/`
  - ADMIN 用戶不需要先成為參與者
  - 一般用戶仍需要先是參與者

### 日誌記錄改進

所有操作都會記錄到 `ActivityLog` 中，包含：
- 用戶角色變更
- ADMIN 自動成為管理者
- 管理權限的移除和添加

這些修復確保了活動管理者和參與者之間的關係更加靈活和合理，特別是對於 ADMIN 用戶的特殊權限處理。