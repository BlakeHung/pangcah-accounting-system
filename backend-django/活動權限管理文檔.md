# 活動權限管理文檔

## 📋 概述

本文檔詳細說明家庭財務管理系統中的活動權限管理機制。系統基於角色和關係定義不同層級的權限，確保財務資訊的安全性和適當的管理權限分配。

## 🔐 權限層級

### 1. 超級管理員 (ADMIN)
- **系統最高權限**
- 可以管理所有活動，不受任何限制
- 可以查看所有活動的財務資訊
- 可以指派和變更活動管理者

### 2. 活動管理者
- **活動的實際管理者**
- 由活動創建者或現有管理者指派
- 可以編輯活動的所有資訊
- 可以查看活動的財務狀況
- 可以管理活動參與者
- **注意**：活動管理者只能在活動創建時設定，後續變更需要現有活動管理者或超級管理員操作

### 3. 群組管理者
- **財務監督角色和活動創建權限**
- 可以查看群組內所有活動的財務狀況
- 可以創建新活動（透過管理任何群組獲得此權限）
- 可以邀請任何系統用戶參與活動（不限於群組成員）
- **無法**編輯既有活動的基本資訊（名稱、時間等）
- 主要用於監控群組內的支出和收入狀況
- **權限來源**：通過 `managed_groups` 欄位判斷，管理任何群組即獲得創建活動權限

### 4. 活動參與者
- 可以在活動中新增支出記錄
- 可以查看自己的分攤資訊
- 無法編輯活動或查看完整財務報表

### 5. 一般用戶
- 只能查看自己參與的活動
- 無法查看未參與活動的任何資訊

## 🛠️ 技術實現

### 後端權限檢查方法

#### `can_user_manage(user)` - 檢查編輯權限
```python
def can_user_manage(self, user) -> bool:
    """檢查用戶是否可以管理此活動"""
    if not user or not user.is_authenticated:
        return False
    
    # 系統管理員可以管理所有活動
    if user.role == 'ADMIN':
        return True
    
    # 活動管理者可以管理
    if self.managers.filter(id=user.id).exists():
        return True
    
    return False
```

#### `can_user_view_finances(user)` - 檢查財務查看權限
```python
def can_user_view_finances(self, user) -> bool:
    """檢查用戶是否可以查看此活動的財務狀況"""
    if not user or not user.is_authenticated:
        return False
    
    # 系統管理員可以查看所有活動
    if user.role == 'ADMIN':
        return True
    
    # 活動管理者可以查看
    if self.managers.filter(id=user.id).exists():
        return True
    
    # 群組管理者可以查看群組內活動的財務狀況
    if self.group and self.group.managers.filter(id=user.id).exists():
        return True
    
    return False
```

### API端點權限控制

所有活動編輯操作（`PUT`、`PATCH`）都會先檢查 `can_user_manage` 權限：

```python
def update(self, request, *args, **kwargs):
    """更新活動並檢查權限"""
    instance = self.get_object()
    
    # 檢查用戶是否有管理權限
    if not instance.can_user_manage(request.user):
        return Response(
            {'error': '您沒有權限編輯此活動'},
            status=status.HTTP_403_FORBIDDEN
        )
    
    return super().update(request, *args, **kwargs)
```

### 前端權限控制

#### 活動列表和新增按鈕權限
前端通過用戶的 `managed_groups` 欄位判斷創建活動權限：

```typescript
const canManageActivities = (): boolean => {
  if (!currentUser) return false
  
  // ADMIN可以新增活動
  if (currentUser.role === 'ADMIN') return true
  
  // 群組管理者可以新增活動 - 檢查是否管理任何群組
  if (currentUser.managed_groups && currentUser.managed_groups.length > 0) return true
  
  return false
}
```

#### 活動編輯權限
前端依賴後端API返回的權限欄位：
- `is_user_manager`: 是否為活動管理者（可編輯）
- `can_user_view_finances`: 是否可查看財務資訊

```typescript
// ActivityNew.tsx 中的權限檢查
const canCreateActivity = user.role === 'ADMIN' || (user.managed_groups && user.managed_groups.length > 0)
if (!canCreateActivity) {
  navigate('/activities')
  return
}
```

## 📊 權限矩陣

| 角色 | 創建活動 | 編輯活動 | 查看財務 | 新增支出 | 邀請參與者 |
|------|---------|---------|---------|---------|-------------|
| 超級管理員 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 活動管理者 | ❌** | ✅ | ✅ | ✅ | ✅ |
| 群組管理者 | ✅ | ❌ | ✅ | ✅* | ✅ |
| 活動參與者 | ❌ | ❌ | ❌ | ✅ | ❌ |
| 一般用戶 | ❌ | ❌ | ❌ | ❌ | ❌ |

*群組管理者需要先加入活動成為參與者才能新增支出
**活動管理者只能管理既有活動，不能直接創建新活動（需要是ADMIN或GROUP_MANAGER）

## 🔄 權限變更流程

### 新增活動管理者
1. 只能由現有活動管理者或超級管理員操作
2. 在活動管理頁面的「管理者設定」中新增
3. 被指派的用戶立即獲得完整管理權限

### 移除活動管理者
1. 只能由超級管理員操作
2. 至少保留一位活動管理者
3. 移除後該用戶立即失去管理權限

## 💡 最佳實踐

1. **最小權限原則**：只給予用戶完成任務所需的最小權限
2. **定期審查**：定期檢查活動管理者名單，移除不需要的管理者
3. **群組管理者運用**：善用群組管理者角色進行財務監督，而不是給予過多的編輯權限
4. **活動生命週期**：活動結算後自動鎖定，防止後續修改

## 🚨 注意事項

1. 活動管理者的設定在活動創建時就要確定，後續變更需要謹慎
2. 群組管理者無法編輯活動，這是設計上的限制，不是錯誤
3. 超級管理員的權限很大，應該限制超級管理員帳號的數量
4. 所有權限變更都會記錄在活動日誌中，便於審計

## 🔧 權限修復歷史

### 2025-08-08: 新增活動按鈕權限修復
**問題**：群組管理者無法看到「新增活動」按鈕，無法進入ActivityNew頁面

**原因**：
1. 前端權限邏輯使用了不存在的 `GROUP_MANAGER` 角色
2. `/api/v1/auth/users/me/` 端點未返回 `managed_groups` 信息
3. 登入時儲存的用戶資料缺少群組管理信息

**修復內容**：
1. 修改後端 `UserViewSet.me()` 使用 `UserDetailSerializer` 返回完整用戶信息
2. 更新 `Activities.tsx` 權限檢查邏輯：改為檢查 `managed_groups.length > 0`
3. 更新 `ActivityNew.tsx` 權限檢查：同樣改為檢查 `managed_groups`
4. 更新 `LoginPage.tsx` 保存用戶資料時包含 `managed_groups`

**測試結果**：
- ADMIN (role='ADMIN'): ✅ 可創建活動
- 群組管理者 (managed_groups.length > 0): ✅ 可創建活動  
- 一般用戶 (managed_groups.length = 0): ❌ 無法創建活動

## 📝 更新記錄

- 2025-08-07: 初始版本，區分活動管理者和群組管理者權限
- 2025-08-07: 新增 `can_user_view_finances` 方法，允許群組管理者查看財務
- 2025-08-07: 新增跨群組邀請功能，允許邀請任何系統用戶參與活動
- 2025-08-08: 修復群組管理者新增活動權限問題，更新前後端權限檢查邏輯